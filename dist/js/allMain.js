"use strict";var _createClass=function(){function n(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,a){return t&&n(e.prototype,t),a&&n(e,a),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var controller,model=void 0,view=void 0,Model=function(){function e(){_classCallCheck(this,e),this._arrRestaurants=[],this._arrCuisineOptions=[],this._arrNeighborhoodOptions=[]}return _createClass(e,[{key:"addFetchedRestaurants",value:function(e){this._arrRestaurants=e}},{key:"addUrlsToRestaurants",value:function(){this._arrRestaurants.map(function(e){e.imgUrl="/img/"+e.photograph,e.url="./restaurant.html?id="+e.id})}},{key:"toggleRestaurantFavorite",value:function(e){e--,this._arrRestaurants[e].is_favorite=!this._arrRestaurants[e].is_favorite}},{key:"getRestaurantFavorite",value:function(e){return e--,this._arrRestaurants[e].is_favorite}},{key:"getRestaurantById",value:function(e){return e--,this._arrRestaurants[e]}},{key:"setArrOptions",value:function(t){var a=this._arrRestaurants.map(function(e){return e[t]}),e=a.filter(function(e,t){return a.indexOf(e)==t});"neighborhood"===t?this._arrNeighborhoodOptions=e:this._arrCuisineOptions=e}},{key:"getRestaurantsByCuisineAndNeighborhood",value:function(t,a){var e=this._arrRestaurants;return"all"!=t&&(e=e.filter(function(e){return e.cuisine_type==t})),"all"!=a&&(e=e.filter(function(e){return e.neighborhood==a})),e}},{key:"getNeighborhoodOptions",value:function(){return this._arrNeighborhoodOptions}},{key:"getCuisineOptions",value:function(){return this._arrCuisineOptions}}]),e}(),View=function(){function e(){_classCallCheck(this,e),this._neighborhoodSelect=document.getElementById("neighborhoods-select"),this._cuisineSelect=document.getElementById("cuisines-select"),this._restaurantsList=document.getElementById("restaurants-list"),this._map="",this._mapDiv=document.getElementById("map"),this._mapMarkers=[],this._isMapDisplayed=!1,this._showMapBtn=document.getElementById("show-map"),this._displayedRestaurants=[],this._offlineMessage=document.getElementById("offline-message")}return _createClass(e,[{key:"displayOfflineMessage",value:function(e){this._offlineMessage.hidden=!e}},{key:"fillSelectField",value:function(a,e){e.forEach(function(e){var t=document.createElement("option");t.innerHTML=e,t.value=e,a.append(t)})}},{key:"getSelectedNeighborhood",value:function(){var e=this._neighborhoodSelect.selectedIndex;return this._neighborhoodSelect[e].value}},{key:"getSelectedCuisine",value:function(){var e=this._cuisineSelect.selectedIndex;return this._cuisineSelect[e].value}},{key:"createRestaurantHTML",value:function(e){var t=document.createElement("li"),a=document.createElement("img");a.className="restaurant-img";var n=e.imgUrl;"/img/undefined"===n?(n="/img/generic.png",a.alt="Generic Restaurant Placeholder Image"):(n="/img/"+(n=n.replace("/img/","").replace(".webp",""))+".webp",a.alt=e.name),a.src=n,t.append(a);var r=document.createElement("h3");r.innerHTML=e.name,t.append(r);var i=document.createElement("p");i.innerHTML=e.neighborhood,t.append(i);var s=document.createElement("p");s.innerHTML=e.address,t.append(s);var o=document.createElement("div");o.className="button-container",t.append(o);var l=document.createElement("a");l.innerHTML="View Details",l.href=e.url,l.setAttribute("aria-label","View details about "+e.name),o.append(l);var u=document.createElement("input");return u.type="image",u.id="toggle-"+e.id,u.src="/img/blankStar.svg",u.alt="Toggle favorite for "+e.name,u.className="toggle-favorite",e.is_favorite&&(u.src="/img/favStar.svg"),u.onclick=function(){controller.toggleFavorite(e.id)},o.append(u),t}},{key:"setDisplayedRestaurants",value:function(e){this._displayedRestaurants=e}},{key:"updateDisplayedRestaurants",value:function(){this._restaurantsList.innerHTML="",this._displayedRestaurants.forEach(function(e){this._restaurantsList.append(this.createRestaurantHTML(e))},this)}},{key:"updateToggleFavorite",value:function(e,t){var a=document.getElementById("toggle-"+e);a.src=t?"/img/favStar.svg":"/img/blankStar.svg"}},{key:"initMap",value:function(){this._map=new google.maps.Map(this._mapDiv,{zoom:12,center:{lat:40.722216,lng:-73.987501},scrollwheel:!1}),this._mapDiv.setAttribute("style","height:400px"),this._isMapDisplayed=!0}},{key:"createMapMarker",value:function(e){return new google.maps.Marker({position:e.latlng,title:e.name,url:e.url,map:this._map,animation:google.maps.Animation.DROP})}},{key:"addMarkersToMap",value:function(){var a=this;a._displayedRestaurants.forEach(function(e){var t=a.createMapMarker(e);google.maps.event.addListener(t,"click",function(){window.location.href=t.url}),a._mapMarkers.push(t)})}},{key:"updateDisplayedMapMarkers",value:function(){var t=this._displayedRestaurants.map(function(e){return e.name});this._mapMarkers.forEach(function(e){t.includes(e.title)?e.setVisible(!0):e.setVisible(!1)})}},{key:"getIsMapDisplayed",value:function(){return this._isMapDisplayed}},{key:"enableButton",value:function(){this._showMapBtn.innerText="Show Google Maps",this._showMapBtn.disabled=!1}},{key:"showMap",value:function(){this.initMap(),this.addMarkersToMap(),document.getElementById("map-button-div").style.display="none",this._showMapBtn.disabled=!0}}]),e}(),Controller=function(){function e(){_classCallCheck(this,e),this._DB_NAME="db-restaurant-reviews",this._DB_VER=1,this._DB_OBJ_STORE="restaurants",this._DATABASE_SERVER_PORT=1337,this._DATABASE_URL="http://localhost:"+this._DATABASE_SERVER_PORT+"/",this._dbPromise=this.openDatabase(),this._MAX_READYFORMAP_CALLS=2,this._numReadyForMapCalls=0}return _createClass(e,[{key:"openDatabase",value:function(){return"indexedDB"in window?(self=this,idb.open(self._DB_NAME,self._DB_VER,function(e){e.createObjectStore(self._DB_OBJ_STORE,{keyPath:"id"})})):Promise.resolve()}},{key:"saveToDatabase",value:function(e,t){var a=e.transaction(this._DB_OBJ_STORE,"readwrite").objectStore(this._DB_OBJ_STORE);t.forEach(function(e){a.put(e)})}},{key:"fetchRestaurantData",value:function(){return self=this,self._dbPromise.then(function(t){return t.transaction(self._DB_OBJ_STORE).objectStore(self._DB_OBJ_STORE).getAll().then(function(e){return 0===e.length?fetch(self._DATABASE_URL+"restaurants").then(function(e){if(console.log("requesting json from server"),200===e.status)return e.json().then(function(a){return a.forEach(function(e,t){e.reviews=[],a[t]=e}),fetch(self._DATABASE_URL+"reviews").then(function(e){if(200===e.status)return e.json().then(function(e){return e.forEach(function(e){a[e.restaurant_id-1].reviews.push(e)}),self.saveToDatabase(t,a),a})})})}).catch(function(e){console.log("This error in going to network in fetchNetworkJSON: "+e)}):(console.log("Returning data from database."),e)})})}},{key:"readyForMap",value:function(){this._numReadyForMapCalls++,this._numReadyForMapCalls===this._MAX_READYFORMAP_CALLS&&view.enableButton()}},{key:"updateDisplayedRestaurants",value:function(){view.setDisplayedRestaurants(model.getRestaurantsByCuisineAndNeighborhood(view.getSelectedCuisine(),view.getSelectedNeighborhood())),view.updateDisplayedRestaurants(),view.getIsMapDisplayed()&&view.updateDisplayedMapMarkers()}},{key:"toggleFavorite",value:function(e){var t=this;model.toggleRestaurantFavorite(e),view.updateToggleFavorite(e,model.getRestaurantFavorite(e));var a=[];a.push(model.getRestaurantById(e)),t._dbPromise.then(function(e){t.saveToDatabase(e,a)}),t.putFavorite(a[0].id,a[0].is_favorite)}},{key:"putFavorite",value:function(t,a){var n=this;fetch(this._DATABASE_URL+"restaurants/"+t+"/?is_favorite="+a,{method:"PUT"}).then(function(e){}).catch(function(e){console.log("Error in favorite toggle: "+e),n.saveServerRequest("putFavorite",{restaurant_id:t,is_favorite:a})})}},{key:"postReview",value:function(t){var a=this;fetch(a._DATABASE_URL+"reviews/",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(t)}).then(function(e){}).catch(function(e){console.log("Error in posting review: "+e),navigator.onLine||a.saveServerRequest("postReview",t)})}},{key:"saveServerRequest",value:function(e,t){var a=[];localStorage.hasOwnProperty("serverRequests")&&(a=JSON.parse(localStorage.getItem("serverRequests")));var n={func:e,data:t};a.push(n),localStorage.setItem("serverRequests",JSON.stringify(a))}},{key:"executeSavedServerRequests",value:function(e){var t=this;e.forEach(function(e){"putFavorite"===e.func?t.putFavorite(e.data.restaurant_id,e.data.is_favorite):t.postReview(e.data)})}},{key:"registerServiceWorker",value:function(){navigator.serviceWorker&&navigator.serviceWorker.register("/sw.js").then(function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)},function(e){console.log("ServiceWorker registration failed: ",e)})}},{key:"loadSite",value:function(){var t=this;t.fetchRestaurantData().then(function(e){model.addFetchedRestaurants(e),model.addUrlsToRestaurants(),model.setArrOptions("neighborhood"),model.setArrOptions("cuisine_type"),view.fillSelectField(view._neighborhoodSelect,model.getNeighborhoodOptions()),view.fillSelectField(view._cuisineSelect,model.getCuisineOptions()),t.updateDisplayedRestaurants(),t.readyForMap()})}}]),e}();document.addEventListener("DOMContentLoaded",function(e){model=new Model,view=new View,(controller=new Controller).registerServiceWorker(),controller.loadSite(),navigator.onLine?localStorage.hasOwnProperty("serverRequests")&&(controller.executeSavedServerRequests(JSON.parse(localStorage.getItem("serverRequests"))),localStorage.removeItem("serverRequests")):view.displayOfflineMessage(!0),window.addEventListener("offline",function(){view.displayOfflineMessage(!0)}),window.addEventListener("online",function(){view.displayOfflineMessage(!1),localStorage.hasOwnProperty("serverRequests")&&(controller.executeSavedServerRequests(JSON.parse(localStorage.getItem("serverRequests"))),localStorage.removeItem("serverRequests"))})});