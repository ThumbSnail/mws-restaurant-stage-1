"use strict";var _createClass=function(){function a(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var controller,model=void 0,view=void 0,Model=function(){function e(){_classCallCheck(this,e),this._arrRestaurants=[],this._arrCuisineOptions=[],this._arrNeighborhoodOptions=[]}return _createClass(e,[{key:"addFetchedRestaurants",value:function(e){this._arrRestaurants=e}},{key:"addUrlsToRestaurants",value:function(){this._arrRestaurants.map(function(e){e.imgUrl="/img/"+e.photograph,e.url="./restaurant.html?id="+e.id})}},{key:"setArrOptions",value:function(t){var n=this._arrRestaurants.map(function(e){return e[t]}),e=n.filter(function(e,t){return n.indexOf(e)==t});"neighborhood"===t?this._arrNeighborhoodOptions=e:this._arrCuisineOptions=e}},{key:"getRestaurantsByCuisineAndNeighborhood",value:function(t,n){var e=this._arrRestaurants;return"all"!=t&&(e=e.filter(function(e){return e.cuisine_type==t})),"all"!=n&&(e=e.filter(function(e){return e.neighborhood==n})),e}},{key:"getNeighborhoodOptions",value:function(){return this._arrNeighborhoodOptions}},{key:"getCuisineOptions",value:function(){return this._arrCuisineOptions}}]),e}(),View=function(){function e(){_classCallCheck(this,e),this._neighborhoodSelect=document.getElementById("neighborhoods-select"),this._cuisineSelect=document.getElementById("cuisines-select"),this._restaurantsList=document.getElementById("restaurants-list"),this._map="",this._mapDiv=document.getElementById("map"),this._mapMarkers=[],this._isMapDisplayed=!1,this._displayedRestaurants=[]}return _createClass(e,[{key:"fillSelectField",value:function(n,e){e.forEach(function(e){var t=document.createElement("option");t.innerHTML=e,t.value=e,n.append(t)})}},{key:"getSelectedNeighborhood",value:function(){var e=this._neighborhoodSelect.selectedIndex;return this._neighborhoodSelect[e].value}},{key:"getSelectedCuisine",value:function(){var e=this._cuisineSelect.selectedIndex;return this._cuisineSelect[e].value}},{key:"createRestaurantHTML",value:function(e){var t=document.createElement("li"),n=document.createElement("img");n.className="restaurant-img";var a=e.imgUrl;a="/img/"+(a=a.replace("/img/","").replace(".jpg",""))+"-2x.jpg",n.src=a,n.alt=e.name,t.append(n);var i=document.createElement("h3");i.innerHTML=e.name,t.append(i);var r=document.createElement("p");r.innerHTML=e.neighborhood,t.append(r);var s=document.createElement("p");s.innerHTML=e.address,t.append(s);var o=document.createElement("div");t.append(o);var l=document.createElement("a");return l.innerHTML="View Details",l.href=e.url,l.setAttribute("aria-label","View details about "+e.name),o.append(l),t}},{key:"setDisplayedRestaurants",value:function(e){this._displayedRestaurants=e}},{key:"updateDisplayedRestaurants",value:function(){this._restaurantsList.innerHTML="",this._displayedRestaurants.forEach(function(e){this._restaurantsList.append(this.createRestaurantHTML(e))},this)}},{key:"initMap",value:function(){this._map=new google.maps.Map(this._mapDiv,{zoom:12,center:{lat:40.722216,lng:-73.987501},scrollwheel:!1}),this._mapDiv.setAttribute("style","height:400px"),this._isMapDisplayed=!0}},{key:"createMapMarker",value:function(e){return new google.maps.Marker({position:e.latlng,title:e.name,url:e.url,map:this._map,animation:google.maps.Animation.DROP})}},{key:"addMarkersToMap",value:function(){var n=this;n._displayedRestaurants.forEach(function(e){var t=n.createMapMarker(e);google.maps.event.addListener(t,"click",function(){window.location.href=t.url}),n._mapMarkers.push(t)})}},{key:"updateDisplayedMapMarkers",value:function(){var t=this._displayedRestaurants.map(function(e){return e.name});this._mapMarkers.forEach(function(e){t.includes(e.title)?e.setVisible(!0):e.setVisible(!1)})}},{key:"getIsMapDisplayed",value:function(){return this._isMapDisplayed}}]),e}(),Controller=function(){function e(){_classCallCheck(this,e),this._DB_NAME="db-restaurant-reviews",this._DB_VER=1,this._DB_OBJ_STORE="restaurants",this._DATABASE_SERVER_PORT=1337,this._DATABASE_URL="http://localhost:"+this._DATABASE_SERVER_PORT+"/",this._dbPromise=this.openDatabase(),this._MAX_READYFORMAP_CALLS=2,this._numReadyForMapCalls=0}return _createClass(e,[{key:"openDatabase",value:function(){return"indexedDB"in window?(self=this,idb.open(self._DB_NAME,self._DB_VER,function(e){e.createObjectStore(self._DB_OBJ_STORE,{keyPath:"id"})})):Promise.resolve()}},{key:"saveToDatabase",value:function(e,t){var n=e.transaction(this._DB_OBJ_STORE,"readwrite").objectStore(this._DB_OBJ_STORE);t.forEach(function(e){n.put(e)})}},{key:"fetchRestaurantData",value:function(){return self=this,self._dbPromise.then(function(t){return t.transaction(self._DB_OBJ_STORE).objectStore(self._DB_OBJ_STORE).getAll().then(function(e){return 0===e.length?fetch(self._DATABASE_URL+"restaurants").then(function(e){if(console.log("requesting json from server"),200===e.status)return e.json().then(function(e){return self.saveToDatabase(t,e),e})}).catch(function(e){console.log("This error in going to network in fetchNetworkJSON: "+e)}):(console.log("Returning data from database."),e)})})}},{key:"readyForMap",value:function(){this._numReadyForMapCalls++,this._numReadyForMapCalls===this._MAX_READYFORMAP_CALLS&&(view.initMap(),view.addMarkersToMap())}},{key:"updateDisplayedRestaurants",value:function(){view.setDisplayedRestaurants(model.getRestaurantsByCuisineAndNeighborhood(view.getSelectedCuisine(),view.getSelectedNeighborhood())),view.updateDisplayedRestaurants(),view.getIsMapDisplayed()&&view.updateDisplayedMapMarkers()}},{key:"registerServiceWorker",value:function(){navigator.serviceWorker&&navigator.serviceWorker.register("/sw.js").then(function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)},function(e){console.log("ServiceWorker registration failed: ",e)})}},{key:"loadSite",value:function(){var t=this;t.fetchRestaurantData().then(function(e){model.addFetchedRestaurants(e),model.addUrlsToRestaurants(),model.setArrOptions("neighborhood"),model.setArrOptions("cuisine_type"),view.fillSelectField(view._neighborhoodSelect,model.getNeighborhoodOptions()),view.fillSelectField(view._cuisineSelect,model.getCuisineOptions()),t.updateDisplayedRestaurants(),t.readyForMap()})}}]),e}();document.addEventListener("DOMContentLoaded",function(e){model=new Model,view=new View,(controller=new Controller).registerServiceWorker(),controller.loadSite()});