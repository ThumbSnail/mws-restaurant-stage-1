"use strict";var _createClass=function(){function n(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,a){return t&&n(e.prototype,t),a&&n(e,a),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var controller,model=void 0,view=void 0,Model=function(){function e(){_classCallCheck(this,e),this._arrRestaurants=[],this._currentId=this.extractIdFromURL()}return _createClass(e,[{key:"addFetchedRestaurants",value:function(e){this._arrRestaurants=e}},{key:"addUrlsToRestaurants",value:function(){this._arrRestaurants.map(function(e){e.imgUrl="/img/"+e.photograph})}},{key:"extractIdFromURL",value:function(){var e=window.location.href;return e.substring(e.indexOf("=")+1)}},{key:"getCurrentRestaurant",value:function(){var t=this;return t._arrRestaurants.find(function(e){return e.id==t._currentId})}},{key:"toggleRestaurantFavorite",value:function(e){e--,this._arrRestaurants[e].is_favorite=!this._arrRestaurants[e].is_favorite}},{key:"getRestaurantFavorite",value:function(e){return e--,this._arrRestaurants[e].is_favorite}},{key:"getNextReviewIndex",value:function(){var t=0;return this._arrRestaurants.forEach(function(e){t+=e.reviews.length}),t+1}},{key:"addReview",value:function(e){this._arrRestaurants[this._currentId-1].reviews.push(e)}},{key:"replaceLastReview",value:function(e){this._arrRestaurants[this._currentId-1].reviews.pop(),this._arrRestaurants[this._currentId-1].reviews.push(e)}}]),e}(),View=function(){function e(){_classCallCheck(this,e),this._map="",this._mapDiv=document.getElementById("map"),this._mapMarkers=[],this._isMapDisplayed=!1,this._showMapBtn=document.getElementById("show-map"),this._displayedRestaurant="",this._offlineMessage=document.getElementById("offline-message"),this._formContainer=document.getElementById("form-container"),this._userName=document.getElementById("form-name"),this._userRating=document.getElementById("form-rating"),this._userComments=document.getElementById("form-comments")}return _createClass(e,[{key:"displayOfflineMessage",value:function(e){this._offlineMessage.hidden=!e}},{key:"setDisplayedRestaurant",value:function(e){this._displayedRestaurant=e}},{key:"fillRestaurantHTML",value:function(){document.getElementById("restaurant-name").innerHTML=this._displayedRestaurant.name;var e=document.getElementById("toggle-");e.id="toggle-"+this._displayedRestaurant.id,e.alt="Toggle favorite for "+this._displayedRestaurant.name,e.className="toggle-favorite",this._displayedRestaurant.is_favorite&&(e.src="/img/favStar.svg"),e.onclick=function(){controller.toggleFavorite()},document.getElementById("restaurant-address").innerHTML=this._displayedRestaurant.address;var t=document.getElementById("restaurant-img");t.className="restaurant-img";var a=this._displayedRestaurant.imgUrl;"/img/undefined"===a?(a="/img/generic.png",t.alt="Generic Restaurant Placeholder Image"):(a="/img/"+(a=a.replace("/img/","").replace(".webp",""))+".webp",t.alt=this._displayedRestaurant.name),t.src=a,document.getElementById("restaurant-cuisine").innerHTML=this._displayedRestaurant.cuisine_type,this._displayedRestaurant.operating_hours&&this.fillRestaurantHoursHTML(),this.fillReviewsHTML()}},{key:"fillRestaurantHoursHTML",value:function(){var e=document.getElementById("restaurant-hours");for(var t in this._displayedRestaurant.operating_hours){var a=document.createElement("tr"),n=document.createElement("td");n.innerHTML=t,a.appendChild(n);var r=document.createElement("td"),i=this._displayedRestaurant.operating_hours[t];i=i.replace(", ","<br>"),r.innerHTML=i,a.appendChild(r),e.appendChild(a)}}},{key:"fillReviewsHTML",value:function(e){var t=this,a=document.getElementById("reviews-list");if(e)a.appendChild(this.createReviewHTML(e));else{var n=document.getElementById("reviews-container");if(!this._displayedRestaurant.reviews){var r=document.createElement("p");return r.innerHTML="No reviews yet!",void n.appendChild(r)}this._displayedRestaurant.reviews.forEach(function(e){a.appendChild(t.createReviewHTML(e))}),n.appendChild(a)}}},{key:"createReviewHTML",value:function(e){var t=document.createElement("li"),a=document.createElement("p");a.innerHTML=e.name,t.appendChild(a);var n=document.createElement("p"),r=new Date(e.createdAt),i=r.getMonth()+"/"+r.getDate()+"/"+r.getFullYear();n.innerHTML=i,t.appendChild(n);var s=document.createElement("p");s.className="rating-text",s.innerHTML="Rating: "+e.rating,t.appendChild(s);var o=document.createElement("p");return o.className="review-text",o.innerHTML=e.comments,t.appendChild(o),t}},{key:"fillBreadcrumb",value:function(){var e=document.getElementById("breadcrumb"),t=document.createElement("li");t.innerHTML=this._displayedRestaurant.name,e.appendChild(t)}},{key:"updateToggleFavorite",value:function(){var e=document.getElementById("toggle-"+this._displayedRestaurant.id);this._displayedRestaurant.is_favorite?e.src="/img/favStar.svg":e.src="/img/blankStar.svg"}},{key:"showReviewForm",value:function(){this._formContainer.className="",document.getElementById("btn-review").className="hidden-form"}},{key:"hideReviewForm",value:function(){this._formContainer.className="hidden-form",document.getElementById("btn-review").className=""}},{key:"getFormValues",value:function(){var e={};return e.name=this._userName.value,e.rating=this._userRating.value,e.comments=this._userComments.value,e}},{key:"initMap",value:function(){this._map=new google.maps.Map(this._mapDiv,{zoom:16,center:this._displayedRestaurant.latlng,scrollwheel:!1}),this._mapDiv.setAttribute("style","height:400px");new google.maps.Marker({position:this._displayedRestaurant.latlng,title:this._displayedRestaurant.name,map:this._map,animation:google.maps.Animation.DROP})}},{key:"enableButton",value:function(){this._showMapBtn.innerText="Show Google Maps",this._showMapBtn.disabled=!1}},{key:"showMap",value:function(){this.initMap(),document.getElementById("map-button-div").style.display="none",this._showMapBtn.disabled=!0}}]),e}(),Controller=function(){function e(){_classCallCheck(this,e),this._DB_NAME="db-restaurant-reviews",this._DB_VER=1,this._DB_OBJ_STORE="restaurants",this._DATABASE_SERVER_PORT=1337,this._DATABASE_URL="http://localhost:"+this._DATABASE_SERVER_PORT+"/",this._dbPromise=this.openDatabase(),this._MAX_READYFORMAP_CALLS=2,this._numReadyForMapCalls=0}return _createClass(e,[{key:"toggleFavorite",value:function(){var t=this,e=model.getCurrentRestaurant();model.toggleRestaurantFavorite(e.id),view.updateToggleFavorite();var a=[];a.push(e),t._dbPromise.then(function(e){t.saveToDatabase(e,a)}),t.putFavorite(a[0].id,a[0].is_favorite)}},{key:"putFavorite",value:function(t,a){var n=this;fetch(this._DATABASE_URL+"restaurants/"+t+"/?is_favorite="+a,{method:"PUT"}).then(function(e){}).catch(function(e){console.log("Error in favorite toggle: "+e),n.saveServerRequest("putFavorite",{restaurant_id:t,is_favorite:a})})}},{key:"submitReview",value:function(){var t=this,e=view.getFormValues();e.restaurant_id=model._currentId,e.id=model.getNextReviewIndex(),e.createdAt=(new Date).getTime(),e.updatedAt=e.createdAt,model.addReview(e),view.fillReviewsHTML(e);var a=[];a.push(model.getCurrentRestaurant()),t._dbPromise.then(function(e){t.saveToDatabase(e,a)}),t.postReview(e),view.hideReviewForm()}},{key:"postReview",value:function(t){var a=this;fetch(a._DATABASE_URL+"reviews/",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(t)}).then(function(e){}).catch(function(e){console.log("Error in posting review: "+e),navigator.onLine||a.saveServerRequest("postReview",t)})}},{key:"saveServerRequest",value:function(e,t){var a=[];localStorage.hasOwnProperty("serverRequests")&&(a=JSON.parse(localStorage.getItem("serverRequests")));var n={func:e,data:t};a.push(n),localStorage.setItem("serverRequests",JSON.stringify(a))}},{key:"executeSavedServerRequests",value:function(e){var t=this;e.forEach(function(e){"putFavorite"===e.func?t.putFavorite(e.data.restaurant_id,e.data.is_favorite):t.postReview(e.data)})}},{key:"openDatabase",value:function(){if(!("indexedDB"in window))return Promise.resolve();var t=this;return idb.open(t._DB_NAME,t._DB_VER,function(e){e.createObjectStore(t._DB_OBJ_STORE,{keyPath:"id"})})}},{key:"saveToDatabase",value:function(e,t){var a=e.transaction(this._DB_OBJ_STORE,"readwrite").objectStore(this._DB_OBJ_STORE);t.forEach(function(e){a.put(e)})}},{key:"fetchRestaurantData",value:function(){var n=this;return n._dbPromise.then(function(t){return t.transaction(n._DB_OBJ_STORE).objectStore(n._DB_OBJ_STORE).getAll().then(function(e){return 0===e.length?fetch(n._DATABASE_URL+"restaurants").then(function(e){if(console.log("requesting json from server"),200===e.status)return e.json().then(function(a){return a.forEach(function(e,t){e.reviews=[],a[t]=e}),fetch(n._DATABASE_URL+"reviews").then(function(e){if(200===e.status)return e.json().then(function(e){return e.forEach(function(e){a[e.restaurant_id-1].reviews.push(e)}),n.saveToDatabase(t,a),a})})})}).catch(function(e){console.log("This error in going to network in fetchNetworkJSON: "+e)}):(console.log("Returning data from database."),e)})})}},{key:"readyForMap",value:function(){this._numReadyForMapCalls++,this._numReadyForMapCalls===this._MAX_READYFORMAP_CALLS&&view.enableButton()}},{key:"registerServiceWorker",value:function(){navigator.serviceWorker&&navigator.serviceWorker.register("/sw.js").then(function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)},function(e){console.log("ServiceWorker registration failed: ",e)})}},{key:"loadContent",value:function(){var t=this;t.fetchRestaurantData().then(function(e){model.addFetchedRestaurants(e),model.addUrlsToRestaurants(),view.setDisplayedRestaurant(model.getCurrentRestaurant()),view.fillRestaurantHTML(),view.fillBreadcrumb(),t.readyForMap()})}}]),e}();document.addEventListener("DOMContentLoaded",function(e){model=new Model,view=new View,(controller=new Controller).registerServiceWorker(),controller.loadContent(),navigator.onLine?localStorage.hasOwnProperty("serverRequests")&&(controller.executeSavedServerRequests(JSON.parse(localStorage.getItem("serverRequests"))),localStorage.removeItem("serverRequests")):view.displayOfflineMessage(!0),window.addEventListener("offline",function(){view.displayOfflineMessage(!0)}),window.addEventListener("online",function(){view.displayOfflineMessage(!1),localStorage.hasOwnProperty("serverRequests")&&(controller.executeSavedServerRequests(JSON.parse(localStorage.getItem("serverRequests"))),localStorage.removeItem("serverRequests"))})});