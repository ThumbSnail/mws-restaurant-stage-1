"use strict";var _createClass=function(){function n(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,a){return t&&n(e.prototype,t),a&&n(e,a),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var controller,model=void 0,view=void 0,Model=function(){function e(){_classCallCheck(this,e),this._arrRestaurants=[],this._currentId=this.extractIdFromURL()}return _createClass(e,[{key:"addFetchedRestaurants",value:function(e){this._arrRestaurants=e}},{key:"addUrlsToRestaurants",value:function(){this._arrRestaurants.map(function(e){e.imgUrl="/img/"+e.photograph})}},{key:"extractIdFromURL",value:function(){var e=window.location.href;return e.substring(e.indexOf("=")+1)}},{key:"getCurrentRestaurant",value:function(){var t=this;return t._arrRestaurants.find(function(e){return e.id==t._currentId})}}]),e}(),View=function(){function e(){_classCallCheck(this,e),this._map="",this._mapDiv=document.getElementById("map"),this._mapMarkers=[],this._isMapDisplayed=!1,this._displayedRestaurant=""}return _createClass(e,[{key:"setDisplayedRestaurant",value:function(e){this._displayedRestaurant=e}},{key:"fillRestaurantHTML",value:function(){document.getElementById("restaurant-name").innerHTML=this._displayedRestaurant.name,document.getElementById("restaurant-address").innerHTML=this._displayedRestaurant.address;var e=document.getElementById("restaurant-img");e.className="restaurant-img";var t=this._displayedRestaurant.imgUrl;t="/img/"+(t=t.replace("/img/","").replace(".jpg",""))+"-2x.jpg",e.src=t,e.alt=this._displayedRestaurant.name,document.getElementById("restaurant-cuisine").innerHTML=this._displayedRestaurant.cuisine_type,this._displayedRestaurant.operating_hours&&this.fillRestaurantHoursHTML(),this.fillReviewsHTML()}},{key:"fillRestaurantHoursHTML",value:function(){var e=document.getElementById("restaurant-hours");for(var t in this._displayedRestaurant.operating_hours){var a=document.createElement("tr"),n=document.createElement("td");n.innerHTML=t,a.appendChild(n);var r=document.createElement("td"),i=this._displayedRestaurant.operating_hours[t];i=i.replace(", ","<br>"),r.innerHTML=i,a.appendChild(r),e.appendChild(a)}}},{key:"fillReviewsHTML",value:function(){var t=this,e=document.getElementById("reviews-container"),a=document.createElement("h3");if(a.innerHTML="Reviews",e.appendChild(a),!this._displayedRestaurant.reviews){var n=document.createElement("p");return n.innerHTML="No reviews yet!",void e.appendChild(n)}var r=document.getElementById("reviews-list");this._displayedRestaurant.reviews.forEach(function(e){r.appendChild(t.createReviewHTML(e))}),e.appendChild(r)}},{key:"createReviewHTML",value:function(e){var t=document.createElement("li"),a=document.createElement("p");a.innerHTML=e.name,t.appendChild(a);var n=document.createElement("p");n.innerHTML=e.date,t.appendChild(n);var r=document.createElement("p");r.className="rating-text",r.innerHTML="Rating: "+e.rating,t.appendChild(r);var i=document.createElement("p");return i.className="review-text",i.innerHTML=e.comments,t.appendChild(i),t}},{key:"fillBreadcrumb",value:function(){var e=document.getElementById("breadcrumb"),t=document.createElement("li");t.innerHTML=this._displayedRestaurant.name,e.appendChild(t)}},{key:"initMap",value:function(){this._map=new google.maps.Map(this._mapDiv,{zoom:16,center:this._displayedRestaurant.latlng,scrollwheel:!1}),this._mapDiv.setAttribute("style","height:400px");new google.maps.Marker({position:this._displayedRestaurant.latlng,title:this._displayedRestaurant.name,map:this._map,animation:google.maps.Animation.DROP})}}]),e}(),Controller=function(){function e(){_classCallCheck(this,e),this._DB_NAME="db-restaurant-reviews",this._DB_VER=1,this._DB_OBJ_STORE="restaurants",this._DATABASE_SERVER_PORT=1337,this._DATABASE_URL="http://localhost:"+this._DATABASE_SERVER_PORT+"/",this._dbPromise=this.openDatabase(),this._MAX_READYFORMAP_CALLS=2,this._numReadyForMapCalls=0}return _createClass(e,[{key:"openDatabase",value:function(){return"indexedDB"in window?(self=this,idb.open(self._DB_NAME,self._DB_VER,function(e){e.createObjectStore(self._DB_OBJ_STORE,{keyPath:"id"})})):Promise.resolve()}},{key:"saveToDatabase",value:function(e,t){var a=e.transaction(this._DB_OBJ_STORE,"readwrite").objectStore(this._DB_OBJ_STORE);t.forEach(function(e){a.put(e)})}},{key:"fetchRestaurantData",value:function(){return self=this,self._dbPromise.then(function(t){return t.transaction(self._DB_OBJ_STORE).objectStore(self._DB_OBJ_STORE).getAll().then(function(e){return 0===e.length?fetch(self._DATABASE_URL+"restaurants").then(function(e){if(console.log("requesting json from server"),200===e.status)return e.json().then(function(e){return self.saveToDatabase(t,e),e})}).catch(function(e){console.log("This error in going to network in fetchNetworkJSON: "+e)}):(console.log("Returning data from database."),e)})})}},{key:"readyForMap",value:function(){this._numReadyForMapCalls++,this._numReadyForMapCalls===this._MAX_READYFORMAP_CALLS&&view.initMap()}},{key:"loadContent",value:function(){var t=this;t.fetchRestaurantData().then(function(e){model.addFetchedRestaurants(e),model.addUrlsToRestaurants(),view.setDisplayedRestaurant(model.getCurrentRestaurant()),view.fillRestaurantHTML(),view.fillBreadcrumb(),t.readyForMap()})}}]),e}();document.addEventListener("DOMContentLoaded",function(e){model=new Model,view=new View,(controller=new Controller).loadContent()});