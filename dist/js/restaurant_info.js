"use strict";var _createClass=function(){function a(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var controller,model=void 0,view=void 0,Model=function(){function e(){_classCallCheck(this,e),this._arrRestaurants=[],this._currentId=this.extractIdFromURL()}return _createClass(e,[{key:"addFetchedRestaurants",value:function(e){this._arrRestaurants=e}},{key:"addUrlsToRestaurants",value:function(){this._arrRestaurants.map(function(e){e.imgUrl="/img/"+e.photograph})}},{key:"extractIdFromURL",value:function(){var e=window.location.href;return e.substring(e.indexOf("=")+1)}},{key:"getCurrentRestaurant",value:function(){var t=this;return t._arrRestaurants.find(function(e){return e.id==t._currentId})}}]),e}(),View=function(){function e(){_classCallCheck(this,e),this._map="",this._mapDiv=document.getElementById("map"),this._mapMarkers=[],this._isMapDisplayed=!1,this._showMapBtn=document.getElementById("show-map"),this._displayedRestaurant=""}return _createClass(e,[{key:"setDisplayedRestaurant",value:function(e){this._displayedRestaurant=e}},{key:"fillRestaurantHTML",value:function(){document.getElementById("restaurant-name").innerHTML=this._displayedRestaurant.name,document.getElementById("restaurant-address").innerHTML=this._displayedRestaurant.address;var e=document.getElementById("restaurant-img");e.className="restaurant-img";var t=this._displayedRestaurant.imgUrl;t="/img/"+(t=t.replace("/img/","").replace(".jpg",""))+"-2x.jpg",e.src=t,e.alt=this._displayedRestaurant.name,document.getElementById("restaurant-cuisine").innerHTML=this._displayedRestaurant.cuisine_type,this._displayedRestaurant.operating_hours&&this.fillRestaurantHoursHTML(),this.fillReviewsHTML()}},{key:"fillRestaurantHoursHTML",value:function(){var e=document.getElementById("restaurant-hours");for(var t in this._displayedRestaurant.operating_hours){var n=document.createElement("tr"),a=document.createElement("td");a.innerHTML=t,n.appendChild(a);var r=document.createElement("td"),i=this._displayedRestaurant.operating_hours[t];i=i.replace(", ","<br>"),r.innerHTML=i,n.appendChild(r),e.appendChild(n)}}},{key:"fillReviewsHTML",value:function(){var t=this,e=document.getElementById("reviews-container"),n=document.createElement("h3");if(n.innerHTML="Reviews",e.appendChild(n),!this._displayedRestaurant.reviews){var a=document.createElement("p");return a.innerHTML="No reviews yet!",void e.appendChild(a)}var r=document.getElementById("reviews-list");this._displayedRestaurant.reviews.forEach(function(e){r.appendChild(t.createReviewHTML(e))}),e.appendChild(r)}},{key:"createReviewHTML",value:function(e){var t=document.createElement("li"),n=document.createElement("p");n.innerHTML=e.name,t.appendChild(n);var a=document.createElement("p");a.innerHTML=e.date,t.appendChild(a);var r=document.createElement("p");r.className="rating-text",r.innerHTML="Rating: "+e.rating,t.appendChild(r);var i=document.createElement("p");return i.className="review-text",i.innerHTML=e.comments,t.appendChild(i),t}},{key:"fillBreadcrumb",value:function(){var e=document.getElementById("breadcrumb"),t=document.createElement("li");t.innerHTML=this._displayedRestaurant.name,e.appendChild(t)}},{key:"initMap",value:function(){this._map=new google.maps.Map(this._mapDiv,{zoom:16,center:this._displayedRestaurant.latlng,scrollwheel:!1}),this._mapDiv.setAttribute("style","height:400px");new google.maps.Marker({position:this._displayedRestaurant.latlng,title:this._displayedRestaurant.name,map:this._map,animation:google.maps.Animation.DROP})}},{key:"enableButton",value:function(){this._showMapBtn.innerText="Show Google Maps",this._showMapBtn.disabled=!1}},{key:"showMap",value:function(){this.initMap(),document.getElementById("map-button-div").style.display="none",this._showMapBtn.disabled=!0}}]),e}(),Controller=function(){function e(){_classCallCheck(this,e),this._DB_NAME="db-restaurant-reviews",this._DB_VER=1,this._DB_OBJ_STORE="restaurants",this._DATABASE_SERVER_PORT=1337,this._DATABASE_URL="http://localhost:"+this._DATABASE_SERVER_PORT+"/",this._dbPromise=this.openDatabase(),this._MAX_READYFORMAP_CALLS=2,this._numReadyForMapCalls=0}return _createClass(e,[{key:"openDatabase",value:function(){return"indexedDB"in window?(self=this,idb.open(self._DB_NAME,self._DB_VER,function(e){e.createObjectStore(self._DB_OBJ_STORE,{keyPath:"id"})})):Promise.resolve()}},{key:"saveToDatabase",value:function(e,t){var n=e.transaction(this._DB_OBJ_STORE,"readwrite").objectStore(this._DB_OBJ_STORE);t.forEach(function(e){n.put(e)})}},{key:"fetchRestaurantData",value:function(){return self=this,self._dbPromise.then(function(t){return t.transaction(self._DB_OBJ_STORE).objectStore(self._DB_OBJ_STORE).getAll().then(function(e){return 0===e.length?fetch(self._DATABASE_URL+"restaurants").then(function(e){if(console.log("requesting json from server"),200===e.status)return e.json().then(function(e){return self.saveToDatabase(t,e),e})}).catch(function(e){console.log("This error in going to network in fetchNetworkJSON: "+e)}):(console.log("Returning data from database."),e)})})}},{key:"readyForMap",value:function(){this._numReadyForMapCalls++,this._numReadyForMapCalls===this._MAX_READYFORMAP_CALLS&&view.enableButton()}},{key:"registerServiceWorker",value:function(){navigator.serviceWorker&&navigator.serviceWorker.register("/sw.js").then(function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)},function(e){console.log("ServiceWorker registration failed: ",e)})}},{key:"loadContent",value:function(){var t=this;t.fetchRestaurantData().then(function(e){model.addFetchedRestaurants(e),model.addUrlsToRestaurants(),view.setDisplayedRestaurant(model.getCurrentRestaurant()),view.fillRestaurantHTML(),view.fillBreadcrumb(),t.readyForMap()})}}]),e}();document.addEventListener("DOMContentLoaded",function(e){model=new Model,view=new View,(controller=new Controller).registerServiceWorker(),controller.loadContent()});